[tools]
node = "24.13.0"
pnpm = "10.28.1"

[tasks.01-up]
alias = "up"
description = "開発環境起動 (Supabase + Next.js)"
run = "docker compose --env-file supabase/.env -f compose.dev.yml up -d"

[tasks.02-down]
alias = "down"
description = "全環境停止 (Dev/Prod/Supabase)"
run = """
  docker compose --env-file supabase/.env -f compose.prod.yml down
  docker compose --env-file supabase/.env -f compose.dev.yml down
"""

[tasks.03-lint]
alias = "lint"
description = "Lintチェック"
run = "pnpm exec biome lint ./src"

[tasks."04-lint:fix"]
alias = "lint:fix"
description = "Lint修正"
run = "pnpm exec biome lint --fix ./src"

[tasks."05-format:check"]
alias = "format:check"
description = "フォーマット確認"
run = "pnpm exec biome format ./src"

[tasks."06-format"]
alias = "format"
description = "フォーマット適用"
run = "pnpm exec biome format --write ./src"

[tasks."07-docker:build"]
alias = "docker:build"
description = "開発環境をビルドして起動"
run = "docker compose --env-file supabase/.env -f compose.dev.yml up --build -d"

[tasks."08-prod:up"]
alias = "prod:up"
description = "本番環境を起動"
run = "docker compose --env-file supabase/.env -f compose.prod.yml up -d"

[tasks."09-prod:build"]
alias = "prod:build"
description = "本番環境をビルドして起動"
run = "docker compose --env-file supabase/.env -f compose.prod.yml up --build -d"

[tasks."10-prod:down"]
alias = "prod:down"
description = "本番環境を停止 (Supabase含む)"
run = """
  docker compose --env-file supabase/.env -f compose.prod.yml down
  docker compose --env-file supabase/.env -f supabase/docker-compose.yml down
"""

[tasks."11-supabase:reset"]
alias = "supabase:reset"
description = "Supabase DBリセット"
run = "cd supabase && ./reset.sh"

[tasks."12-clean"]
alias = "clean"
description = "ビルド成果物を削除"
run = "rm -rf .next node_modules"

[tasks."13-clean:docker"]
alias = "clean:docker"
description = "Dockerリソースを削除"
run = """
  docker compose --env-file supabase/.env -f compose.dev.yml down -v --rmi local
  docker compose --env-file supabase/.env -f supabase/docker-compose.yml down -v --rmi local
"""

[tasks."14-supabase:db:reset"]
alias = "supabase:db:reset"
description = "Supabase DBをリセットして migrations + seed.sql を適用"
run = """
set -euo pipefail

CID="$(docker ps -q -f name=^/supabase-db$ || true)"
if [ -z "$CID" ]; then
  echo "supabase-db が起動していません。先に Supabase を起動してください"
  exit 1
fi

NET="$(docker inspect supabase-db | python3 -c 'import json,sys; o=json.load(sys.stdin)[0][\"NetworkSettings\"][\"Networks\"]; print(next(iter(o.keys())))')"

docker run --rm -i \\
  --network "$NET" \\
  --env-file supabase/.env \\
  -v "$PWD":/work \\
  -w /work \\
  node:24-bullseye \\
  bash -lc '
    set -euo pipefail
    export PGSSLMODE=disable
    [ -f supabase/config.toml ] || npx -y supabase@latest init
    yes | npx -y supabase@latest db reset --debug \\
      --db-url "postgresql://postgres:${POSTGRES_PASSWORD}@supabase-db:5432/${POSTGRES_DB}?sslmode=disable"
  '
"""
